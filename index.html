<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCL Final Project - Surface Reconstruction</title>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #ffffff;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            padding-bottom: 30px; /* 修改：从 60px 减小到 30px，减小按钮下方留白 */
            border-bottom: 1px solid #eee;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 15px;
            font-weight: normal;
            color: #000;
        }

        .subtitle {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 25px;
        }

        .github-btn {
            display: inline-block;
            background: #fff;
            color: #333;
            padding: 10px 20px;
            text-decoration: none;
            border: 1px solid #333;
            border-radius: 4px;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .github-btn:hover {
            background: #333;
            color: #fff;
        }

        .content {
            background: transparent;
            padding: 0;
            box-shadow: none;
        }

        .section {
            margin-bottom: 60px;
        }

        h2 {
            color: #000;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: normal;
        }

        h3 {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #444;
        }

        p {
            margin-bottom: 15px;
            color: #444;
        }

        /* 视频展示区样式 */
        .figure-section {
            margin-top: 30px;
        }

        .figure-title {
            text-align: center;
            font-style: italic;
            margin-bottom: 20px;
            color: #666;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }

        .video-item video {
            width: 100%;
            display: block;
            background: #f9f9f9;
        }

        .video-caption {
            margin-top: 10px;
            font-size: 0.9em;
            color: #555;
            text-align: center;
        }

        /* --- 新增：3D 查看器样式 --- */
        #viewer-container {
            width: 100%;
            height: 500px;
            background-color: #f9f9f9; /* 浅灰背景，突出白色网格 */
            position: relative;
            border: 1px solid #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        #loading-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            color: #666;
            font-style: italic;
        }

        .model-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .model-btn {
            padding: 8px 16px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            color: #555;
            transition: all 0.2s;
        }

        .model-btn:hover {
            border-color: #999;
            color: #333;
        }

        .model-btn.active {
            background: #333;
            color: #fff;
            border-color: #333;
        }

        /* 技术栈样式 */
        .tech-stack {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tech-item {
            background: #f5f5f5;
            padding: 5px 15px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #666;
            border: none;
        }

        /* 功能列表样式 */
        .features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-top: 20px;
        }

        .feature-card h3 {
            margin-bottom: 10px;
            color: #000;
        }

        .code-block {
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 20px 0;
            overflow-x: auto;
            border: 1px solid #eee;
        }

        .author {
            text-align: center;
            padding: 10px 0;
            margin: 10px 0;
        }

        .footer {
            text-align: center;
            color: #888;
            padding: 20px;
            font-size: 0.9em;
            border-top: 1px solid #eee;
        }

        a {
            color: #0066cc;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        ul {
            padding-left: 20px;
            margin-bottom: 20px;
            color: #444;
        }

        @media (max-width: 768px) {
            .video-grid {
                grid-template-columns: 1fr;
            }
            #viewer-container {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Point Cloud Surface Reconstruction</h1>
            <p class="subtitle">PKU2025Fall VISUAL COMPUTING AND LEARNING Course Final Project</p>
            <div class="author">
                <h3><a href="https://smallyang688.github.io/" target="_blank">Zihan Yang</a><sup>1</sup></h3>
                <p>School of Electronics Engineering and Computer Science, Peking University</p>
            </div>
            <a href="https://github.com/smallyang688/VCL-Final_Project" class="github-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="vertical-align: middle; margin-right: 8px;">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                Code
            </a>
        </div>
    </header>

    <div class="container">
        <div class="content">
            <section class="section">
                <h2>Project Overview</h2>
                <p>
                    This project implements several classic surface reconstruction algorithms in Computer Graphics. 
                    The goal is to analyze and compare different approaches for generating 3D meshes from point cloud data.
                </p>

                <div class="figure-section">
                    <p class="figure-title">Figure 1: Reconstruction results (Video Demo)</p>
                    <div class="video-grid">
                        <div class="video-item">
                            <video autoplay loop muted playsinline>
                                <source src="assets/sphere.mp4" type="video/mp4">
                            </video>
                            <p class="video-caption">(a) Sphere (BPA)</p>
                        </div>
                        <div class="video-item">
                            <video autoplay loop muted playsinline>
                                <source src="assets/dinosaur.mp4" type="video/mp4">
                            </video>
                            <p class="video-caption">(b) Dinosaur (BPA)</p>
                        </div>

                        <div class="video-item">
                            <video autoplay loop muted playsinline>
                                <source src="assets/block.mp4" type="video/mp4">
                            </video>
                            <p class="video-caption">(c) Block (GPT)</p>
                        </div>
                        <div class="video-item">
                            <video autoplay loop muted playsinline>
                                <source src="assets/rocker.mp4" type="video/mp4">
                            </video>
                            <p class="video-caption">(d) Rocker (GPT)</p>
                        </div>

                        <div class="video-item">
                            <video autoplay loop muted playsinline>
                                <source src="assets/fandisk.mp4" type="video/mp4">
                            </video>
                            <p class="video-caption">(e) Fandisk (Poisson)</p>
                        </div>
                        <div class="video-item">
                            <video autoplay loop muted playsinline>
                                <source src="assets/bunny.mp4" type="video/mp4">
                            </video>
                            <p class="video-caption">(f) Bunny (Poisson)</p>
                        </div>

                        <div class="video-item">
                            <video autoplay loop muted playsinline>
                                <source src="assets/arma.mp4" type="video/mp4">
                            </video>
                            <p class="video-caption">(g) Arma (RBF)</p>
                        </div>
                        <div class="video-item">
                            <video autoplay loop muted playsinline>
                                <source src="assets/cup.mp4" type="video/mp4">
                            </video>
                            <p class="video-caption">(h) Cup (RBF)</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>Interactive Mesh Viewer</h2>
                <p>Drag to rotate, scroll to zoom. Toggle between different reconstruction results below.</p>
                
                <div id="viewer-container">
                    <div id="loading-overlay">Select a model from below to view...</div>
                </div>

                <div class="model-controls">
                    <button class="model-btn" data-src="assets/models/sphere.obj">Sphere (BPA)</button>
                    <button class="model-btn" data-src="assets/models/block.obj">Block (GPT)</button>
                    <button class="model-btn" data-src="assets/models/zebra.obj">Zebra (RBF+MC)</button>
                    <button class="model-btn" data-src="assets/models/bottle.obj">Small Bottle (Poisson+MC)</button>
                </div>
            </section>

            <section class="section">
                <h2>Implemented Features</h2>
                <ul>
                    <li><strong>Algorithm Selection:</strong> Provide three reconstruction algorithms for selection: Greedy Projection Triangulation, Ball-Pivoting Algorithm, Marching Cubes.</li>
                    <li><strong>Asset Selection:</strong> In addition to the six models from Lab2, five additional objects including bunny are available for selection.</li>
                    <li><strong>Dynamic Display:</strong> Enabled by default, real-time display of reconstructed patches; if disabled, display all at once after reconstruction. Control the refresh rate for visualization results every certain number of patches through the Refresh Rate parameter.</li>
                    <li><strong>Mesh Processing Panel:</strong> Dynamically display the current Mesh's vertex count and triangle count; after reconstruction, additionally display whether the reconstructed Mesh is manifold and watertight.</li>
                    <li><strong>Mesh Processing Operations:</strong> Support Mesh Smoothing, Mesh Subdivision, Mesh Simplification operations on the reconstructed Mesh. Each operation has adjustable parameters (where Mesh Simplification parameters represent the proportion of points to retain). These operations are only available when the current Mesh is manifold; when the Mesh is non-manifold, a red warning "Warning: Mesh is not manifold!" will be displayed on the right, and the corresponding three Apply buttons will be grayed out and unclickable.</li>
                    <li><strong>Marching Cubes SDF Source:</strong> In the Marching Cubes dropdown menu, the Algorithm item can select to use Poisson or RBF to construct SDF, then extract explicit mesh by Marching Cubes.</li>
                    <li><strong>Export Support:</strong> Support exporting the reconstructed Mesh as .obj format.</li>
                    <li><strong>Import Support:</strong> In Marching Cubes mode, support importing user's .obj or .ply files for surface reconstruction.</li>
                </ul>
            </section>

            <section class="section">
                <h2>Process Demo</h2>
                <p class="figure-title">This is a demonstration of UI interface operations. It showcases manual asset import, surface reconstruction, mesh smoothing, subdivision, and simplification operations, ultimately exporting the reconstructed mesh.</p>
                <div style="text-align: center; margin: 20px 0;">
                    <video id="demo-video" controls style="max-width: 100%; height: auto; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        <source src="assets/demo.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </section>

            <section class="section">
                <h2>Tech Stack</h2>
                <div class="tech-stack">
                    <span class="tech-item">C++17</span>
                    <span class="tech-item">OpenGL</span>
                    <span class="tech-item">GLFW</span>
                    <span class="tech-item">GLM</span>
                    <span class="tech-item">ImGui</span>
                    <span class="tech-item">Three.js (Web)</span>
                </div>
            </section>

            <section class="section">
                <h2>Algorithms</h2>
                <div class="features">
                    <div class="feature-card">
                        <h3>Ball-Pivoting (BPA)</h3>
                        <p>Simulates a ball rolling over the point cloud to form a triangle mesh. Efficient for evenly distributed data.</p>
                    </div>
                    <div class="feature-card">
                        <h3>Greedy Projection (GPT)</h3>
                        <p>A fast, local triangulation approach that projects points onto a local plane. Good for preserving sharp features.</p>
                    </div>
                    <div class="feature-card">
                        <h3>Poisson Reconstruction</h3>
                        <p>Global implicit method solving the Poisson equation. Excellent for creating watertight surfaces from noisy data.</p>
                    </div>
                    <div class="feature-card">
                        <h3>RBF Implicit</h3>
                        <p>Uses Radial Basis Functions to interpolate the surface. Provides smooth results and hole filling capabilities.</p>
                    </div>
                </div>
            </section>

            <section class="section">
                <h2>Getting Started</h2>

                <h3>Step 1: Clone the project</h3>
                <div class="code-block">
git clone https://github.com/smallyang688/VCL-Final_Project.git<br>
cd VCL-Final_Project
                </div>

                <h3>Step 2: Build the project</h3>
                <div class="code-block">
# Automatically download dependencies and build (first run may take a few minutes)<br>
xmake<br><br>
# If you need to specify build mode<br>
xmake config --mode=release  # Release mode<br>
xmake                        # Build
                </div>

                <h3>Step 3: Run the program</h3>
                <div class="code-block">
xmake run final_project
                </div>
            </section>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2026 Zihan Yang. VISUAL COMPUTING AND LEARNING Course Final Project.</p>
    </footer>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';

        let camera, scene, renderer, controls;
        let currentMesh = null;

        const container = document.getElementById('viewer-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const buttons = document.querySelectorAll('.model-btn');

        init();
        animate();

        // 默认加载第一个模型 (如果文件存在)
        if (buttons.length > 0) {
            // activateModel(buttons[0]); // 取消注释此行可自动加载第一个
        }

        function init() {
            // 1. Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff); // 纯白背景
            // 添加一点雾化效果，让深度感更强，但保持白色
            scene.fog = new THREE.Fog(0xffffff, 2, 10);

            // 2. Camera
            camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
            camera.position.set(0, 1.5, 3);

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // 4. Lights
            const ambientLight = new THREE.AmbientLight(0x404040, 1.5); // 柔和的环境光
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5); // 主光源
            dirLight.position.set(2, 5, 5);
            scene.add(dirLight);

            const backLight = new THREE.DirectionalLight(0xffffff, 0.5); // 轮廓光
            backLight.position.set(-2, 2, -5);
            scene.add(backLight);

            // 5. Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true; // 开启阻尼滑动
            controls.dampingFactor = 0.05;

            // Resize listener
            window.addEventListener('resize', onWindowResize);

            // Button listeners
            buttons.forEach(btn => {
                btn.addEventListener('click', () => activateModel(btn));
            });
        }

        function activateModel(btn) {
            // UI 更新
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const modelPath = btn.getAttribute('data-src');
            loadModel(modelPath);
        }

        function loadModel(path) {
            if (!path) return;

            loadingOverlay.style.display = 'flex';
            loadingOverlay.textContent = 'Loading mesh...';

            // 移除旧模型
            if (currentMesh) {
                scene.remove(currentMesh);

                // 正确dispose THREE.Object3D的所有几何体和材质
                currentMesh.traverse(function (child) {
                    if (child.isMesh) {
                        if (child.geometry) {
                            child.geometry.dispose();
                        }
                        if (child.material) {
                            if (Array.isArray(child.material)) {
                                child.material.forEach(material => material.dispose());
                            } else {
                                child.material.dispose();
                            }
                        }
                    }
                });

                currentMesh = null;
            }

            const loader = new OBJLoader();
            loader.load(
                path,
                function (object) {
                    currentMesh = object;
                    
                    // 设置统一材质：灰色，略带高光，方便观察几何结构
                    const material = new THREE.MeshPhongMaterial({ 
                        color: 0x888888, 
                        specular: 0x111111,
                        shininess: 30,
                        flatShading: false,
                        side: THREE.DoubleSide // 双面渲染，防止出现孔洞看起来是透明的
                    });

                    object.traverse(function (child) {
                        if (child.isMesh) {
                            child.material = material;
                        }
                    });

                    // 关键步骤：自动缩放和居中
                    const box = new THREE.Box3().setFromObject(object);
                    const size = box.getSize(new THREE.Vector3());
                    const center = box.getCenter(new THREE.Vector3());

                    // 将模型中心移动到原点
                    object.position.x = -center.x;
                    object.position.y = -center.y;
                    object.position.z = -center.z;

                    // 计算缩放比例，使模型最大边长为 2 (适应相机视角)
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 2.0 / maxDim;
                    object.scale.set(scale, scale, scale);

                    // 创建一个父对象来持有旋转和缩放，方便管理
                    const pivot = new THREE.Group();
                    pivot.add(object);
                    currentMesh = pivot;
                    scene.add(pivot);

                    loadingOverlay.style.display = 'none';
                },
                function (xhr) {
                    // 进度回调
                    if (xhr.lengthComputable) {
                        const percentComplete = Math.round((xhr.loaded / xhr.total) * 100);
                        loadingOverlay.textContent = `Loading: ${percentComplete}%`;
                    }
                },
                function (error) {
                    console.error('An error happened', error);
                    loadingOverlay.textContent = 'Error loading model (Check console)';
                }
            );
        }

        function onWindowResize() {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>